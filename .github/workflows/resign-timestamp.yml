name: Resign TUF Metadata

on:
  schedule:
    - cron: "0 0 * * 0" # every Sunday at midnight UTC
  workflow_dispatch:

jobs:
  refresh-tuf:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          persist-credentials: false

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install tufup
        run: pip install tufup

      - name: Refresh TUF metadata
        run: |
          cd backend/server/repo-win
          tufup sign timestamp keystore -d -e 7
          cd ../repo-mac
          tufup sign timestamp keystore -d -e 7

      - name: Write keystores to temp files
        env:
          ROOT_KEY_MAC: ${{ secrets.TUF_MAC_KEY_ROOT }}
          SNAPSHOT_KEY_MAC: ${{ secrets.TUF_MAC_KEY_SNAPSHOT }}
          TARGETS_KEY_MAC: ${{ secrets.TUF_MAC_KEY_TARGETS }}
          TIMESTAMP_KEY_MAC: ${{ secrets.TUF_MAC_KEY_TIMESTAMP }}

          ROOT_KEY_WIN: ${{ secrets.TUF_WIN_KEY_ROOT }}
          SNAPSHOT_KEY_WIN: ${{ secrets.TUF_WIN_KEY_SNAPSHOT }}
          TARGETS_KEY_WIN: ${{ secrets.TUF_WIN_KEY_TARGETS }}
          TIMESTAMP_KEY_WIN: ${{ secrets.TUF_WIN_KEY_TIMESTAMP }}
        run: |
          mkdir -p backend/server/repo-win/keystore
          mkdir -p backend/server/repo-win/metadata
          echo "$ROOT_KEY_WIN"      | base64 --decode > backend/server/repo-win/keystore/root
          echo "$SNAPSHOT_KEY_WIN"  | base64 --decode > backend/server/repo-win/keystore/snapshot
          echo "$TARGETS_KEY_WIN"   | base64 --decode > backend/server/repo-win/keystore/targets
          echo "$TIMESTAMP_KEY_WIN" | base64 --decode > backend/server/repo-win/keystore/timestamp

          mkdir -p backend/server/repo-mac/keystore
          mkdir -p backend/server/repo-mac/metadata
          echo "$ROOT_KEY_MAC"      | base64 --decode > backend/server/repo-mac/keystore/root
          echo "$SNAPSHOT_KEY_MAC"  | base64 --decode > backend/server/repo-mac/keystore/snapshot
          echo "$TARGETS_KEY_MAC"   | base64 --decode > backend/server/repo-mac/keystore/targets
          echo "$TIMESTAMP_KEY_MAC" | base64 --decode > backend/server/repo-mac/keystore/timestamp

      - name: Sync latest gh-pages metadata into local repo folders
        run: |
          mkdir -p gh-pages/win gh-pages/mac
          rsync -av --delete gh-pages/win/ backend/server/repo-win/metadata/
          rsync -av --delete gh-pages/mac/ backend/server/repo-mac/metadata/

      - name: Refresh (sign) Windows metadata and copy to gh-pages
        run: |
          set -e
          REPO_DIR=backend/server/repo-win
          DEST=gh-pages/win

          cd "${REPO_DIR}"
          tufup sign timestamp keystore -d -e 7

          mkdir -p "../../${DEST}"
          cp -a metadata/. "../../${DEST}/"

      - name: Refresh (sign) mac metadata and copy to gh-pages
        run: |
          set -e
          REPO_DIR=backend/server/repo-mac
          DEST=gh-pages/mac

          cd "${REPO_DIR}"
          tufup sign timestamp keystore -d -e 7

          mkdir -p "../../${DEST}"
          cp -a metadata/. "../../${DEST}/"

      - name: Commit and push updated metadata to gh-pages
        working-directory: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ls -la
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin gh-pages
          git checkout gh-pages

          git add mac win
          git commit -m "Auto-refresh TUF metadata" || echo "No changes to commit"
          git push origin gh-pages

      - name: Cleanup secrets
        if: always()
        run: |
          rm -rf backend/server/repo-mac/keystore
          rm -rf backend/server/repo-mac/metadata
          rm -rf backend/server/repo-win/keystore
          rm -rf backend/server/repo-win/metadata
