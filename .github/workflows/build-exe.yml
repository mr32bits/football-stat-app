name: Build Windows EXE and Sign with TUFUP

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tufup pyinstaller

      - name: Restore tufup keystore
        shell: bash
        run: |
          mkdir -p repo/keystore
          echo "$TUFUP_ROOT_KEY" | base64 -d > repo/keystore/root
          echo "$TUFUP_TARGETS_KEY" | base64 -d > repo/keystore/targets
          echo "$TUFUP_SNAPSHOT_KEY" | base64 -d > repo/keystore/snapshot
          echo "$TUFUP_TIMESTAMP_KEY" | base64 -d > repo/keystore/timestamp
        env:
          TUFUP_ROOT_KEY: ${{ secrets.TUFUP_ROOT_KEY }}
          TUFUP_TARGETS_KEY: ${{ secrets.TUFUP_TARGETS_KEY }}
          TUFUP_SNAPSHOT_KEY: ${{ secrets.TUFUP_SNAPSHOT_KEY }}
          TUFUP_TIMESTAMP_KEY: ${{ secrets.TUFUP_TIMESTAMP_KEY }}

      - name: Prepare tufup_root for build
        run: |
          cp repo/metadata/root.json backend/server/tufup_root

      - name: Build server.exe
        run: |
          cd backend/server
          pyinstaller --clean --noconfirm server.spec

      - name: Package build into tar.gz
        shell: bash
        run: |
          mkdir dist_bundle
          cp backend/server/dist/server.exe dist_bundle
          echo
          VERSION=${GITHUB_REF_NAME#v}
          tar -czf FootballStats-${VERSION}.tar.gz dist_bundle
          echo "Bundle created: FootballStats-${VERSION}.tar.gz"

      - name: Add bundle to tufup repo
        shell: bash
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "${VERSION}"
          echo "-----------------"
          ls
          echo "-----------------"
          ls repo -R
          echo "-----------------"
          mkdir -p repo/targets
          tufup -v targets add -r "${VERSION}" "FootballStats-${VERSION}.tar.gz" "repo/keystore"

      - name: Sign repository metadata
        shell: bash
        run: |
          tufup sign "repo/keystore"

      - name: Upload bundle to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: FootballStats-${{ github.ref_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy metadata to GitHub Pages
        if: startsWith(github.ref, 'refs/tags/')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: repo/metadata
