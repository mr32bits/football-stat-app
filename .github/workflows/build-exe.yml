name: Build Windows EXE and Sign with TUFUP

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tufup pyinstaller

      - name: Build server.exe
        run: |
          cd backend/server
          pyinstaller --clean --noconfirm server.spec

      - name: Package build into tar.gz
        run: |
          mkdir dist_bundle
          copy backend\server\dist\server.exe dist_bundle\
          tar -czf FootballStats-${{ github.ref_name || 'manual' }}.tar.gz dist_bundle
          echo "Bundle created: FootballStats-${{ github.ref_name || 'manual' }}.tar.gz"

      - name: Restore tufup keystore
        shell: bash
        run: |
          mkdir -p repo/keystore
          echo "$TUFUP_ROOT_KEY" | base64 -d > repo/keystore/root_key
          echo "$TUFUP_TARGETS_KEY" | base64 -d > repo/keystore/targets_key
          echo "$TUFUP_SNAPSHOT_KEY" | base64 -d > repo/keystore/snapshot_key
          echo "$TUFUP_TIMESTAMP_KEY" | base64 -d > repo/keystore/timestamp_key
        env:
          TUFUP_ROOT_KEY: ${{ secrets.TUFUP_ROOT_KEY }}
          TUFUP_TARGETS_KEY: ${{ secrets.TUFUP_TARGETS_KEY }}
          TUFUP_SNAPSHOT_KEY: ${{ secrets.TUFUP_SNAPSHOT_KEY }}
          TUFUP_TIMESTAMP_KEY: ${{ secrets.TUFUP_TIMESTAMP_KEY }}

      - name: Add bundle to tufup repo
        shell: bash
        run: |
          cd repo
          tufup targets add ${GITHUB_REF_NAME#v} ../FootballStats-${GITHUB_REF_NAME#v}.tar.gz keystore
          cd ..

      - name: Upload bundle to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: FootballStats-${{ github.ref_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy metadata to GitHub Pages
        if: startsWith(github.ref, 'refs/tags/')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: repo/metadata
